<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- === 1. Primary Meta Tags === -->
    <title>koan.im | Digital Riddles</title>
    <meta name="title" content="koan.im | Digital Riddles">
    <meta name="description" content="A digital monument to the unanswerable. Generate unique Zen Koans powered by AI.">
    <meta name="keywords" content="Zen, Koan, AI, Meditation, Philosophy, Riddle, Generative Art, Mindfulness">
    <meta name="author" content="koan.im (An unearth.im Project)">
    <meta name="robots" content="index, follow">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="language" content="English">
    
    <!-- Canonical Link -->
    <link rel="canonical" href="https://koan.im/" />
 
    <!-- === 2. Webmention Endpoint === -->
    <link rel="webmention" href="https://webmention.io/unearth.im/webmention" />

    <!-- === 3. Open Graph / Facebook === -->
    <meta property="og:type" content="website"> 
    <meta property="og:url" content="https://koan.im/">
    <meta property="og:title" content="koan.im | Digital Riddles">
    <meta property="og:description" content="A digital monument to the unanswerable. Generate unique Zen Koans powered by AI.">
    <meta property="og:image" content="https://koan.im/og-image.png">
    <meta property="og:site_name" content="koan.im">

    <!-- === 4. Twitter Card === -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://koan.im/">
    <meta property="twitter:title" content="koan.im | Digital Riddles">
    <meta property="twitter:description" content="A digital monument to the unanswerable. Generate unique Zen Koans powered by AI.">
    <meta property="twitter:image" content="https://koan.im/og-image.png">

    <!-- === 5. Favicons === -->
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="alternate icon" href="/favicon.ico">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    
    <!-- Brand Color Meta Tags -->
    <meta name="theme-color" content="#f4f1ea">
    <meta name="msapplication-TileColor" content="#a83f39">

    <!-- Google Fonts: Spectral (The 'Book' font) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Spectral:ital,wght@0,300;0,400;0,600;1,300&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --bg-color: #f4f1ea; /* Washi paper */
            --ink-color: #2b2b2b; /* Sumi ink */
            --accent-color: #a83f39; /* Hanko stamp red */
        }

        body {
            background-color: var(--bg-color);
            color: var(--ink-color);
            font-family: 'Spectral', serif;
            transition: background-color 1s ease;
            overflow: hidden;
            user-select: none; /* Make it feel more like an app/object */
        }

        /* The main text container */
        .koan-text {
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            line-height: 1.4;
            font-weight: 300;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 1.5s cubic-bezier(0.22, 1, 0.36, 1), transform 1.5s cubic-bezier(0.22, 1, 0.36, 1);
        }

        .koan-text.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* The 'Seek' button */
        .seek-btn {
            background: transparent;
            border: 1px solid var(--ink-color);
            color: var(--ink-color);
            padding: 12px 32px;
            font-family: 'Spectral', serif;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
            border-radius: 2px;
        }

        .seek-btn:hover {
            background: var(--ink-color);
            color: var(--bg-color);
        }

        .seek-btn:disabled {
            border-color: #a0a0a0;
            color: #a0a0a0;
            cursor: not-allowed;
            background: transparent;
        }

        /* Loading animation dots */
        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }

        /* Counter at the bottom */
        .footer-counter {
            font-size: 0.75rem;
            color: #888;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            opacity: 0.7;
        }
        
        .counter-num {
            font-weight: 600;
            color: var(--accent-color);
        }
        
        /* Subtle texture overlay for 'paper' feel */
        .paper-texture {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.4;
            pointer-events: none;
            z-index: -1;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.15'/%3E%3C/svg%3E");
        }
    </style>
</head>
<body class="h-screen w-full flex flex-col items-center justify-center relative">
    
    <div class="paper-texture"></div>

    <!-- Main Content Area -->
    <main class="w-full max-w-2xl px-8 flex flex-col items-center text-center z-10">
        
        <!-- The Koan Display -->
        <div id="koan-container" class="min-h-[200px] flex items-center justify-center mb-12">
            <p id="koan-display" class="koan-text">
                <span class="italic text-gray-500 text-xl">Empty your mind to begin...</span>
            </p>
        </div>

        <!-- Controls -->
        <div id="controls" class="opacity-0 transition-opacity duration-1000 delay-500">
            <button id="seek-btn" class="seek-btn">
                Seek
            </button>
        </div>

    </main>

    <!-- Footer / Counter -->
    <footer class="absolute bottom-8 text-center z-10 w-full px-4">
        <div class="footer-counter mb-2 flex items-center justify-center">
            <span>Global Contemplations: <span id="counter-display" class="counter-num">...</span></span>
        </div>
        <div class="text-[10px] text-gray-400 font-sans tracking-widest opacity-60">
            a digital monument by <a href="https://unearth.im" target="_blank" rel="noopener noreferrer" class="hover:text-[var(--ink-color)] transition-colors duration-300 border-b border-transparent hover:border-[var(--ink-color)] pb-0.5">unearth.im</a>
        </div>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- JOJO'S CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAEU3QcCzu4ZmwJpHhogu1hMpyRp2swUz8",
            authDomain: "jojo-4b593.firebaseapp.com",
            projectId: "jojo-4b593",
            storageBucket: "jojo-4b593.firebasestorage.app",
            messagingSenderId: "353107431611",
            appId: "1:353107431611:web:7e96cef73360a32544599e",
            measurementId: "G-XNSPMRZZVE"
        };
        
        // Initialize
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let currentUser = null;
        let isGenerating = false;

        // DOM Elements
        const display = document.getElementById('koan-display');
        const btn = document.getElementById('seek-btn');
        const counterDisplay = document.getElementById('counter-display');
        const controls = document.getElementById('controls');

        // Backup Koans (Traditional / Elemental themes)
        const fallbackKoans = [
            "The bamboo is tall, the pine is short. Which one is right?",
            "A tree falls in the deep forest. Does the silence hear it?",
            "You seek the ox while riding the ox.",
            "The reflection of the moon needs no permission to enter the water.",
            "Show me your face before your parents were born.",
            "The bell rings. Is the sound in the bell, or in your ear?",
            "To find the mountain, you must leave the path."
        ];

        // 1. Authentication & Setup
        async function init() {
            try {
                // Anonymous Auth for the Zen experience
                await signInAnonymously(auth);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUser = user;
                        setupRealtimeCounter();
                        // Reveal the button once connected
                        controls.classList.remove('opacity-0');
                    }
                });
            } catch (err) {
                console.error("Connection failed:", err);
                display.innerHTML = "The path is blocked.<br><span class='text-sm text-gray-400'>(Connection Error)</span>";
                display.classList.add('visible');
            }
        }

        // 2. Realtime Counter (Firestore)
        function setupRealtimeCounter() {
            if (!currentUser) return;
            
            // Path: 'koan_stats/global'
            const counterRef = doc(db, 'koan_stats', 'global');

            // Listen for changes
            onSnapshot(counterRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    counterDisplay.innerText = (data.contemplations || 0).toLocaleString();
                } else {
                    // Initialize if it doesn't exist
                    setDoc(counterRef, { contemplations: 0 }, { merge: true }).catch(e => {
                        console.log("Initialization skipped:", e);
                        counterDisplay.innerText = "0";
                    });
                }
            }, (error) => {
                console.error("Counter error:", error);
                counterDisplay.innerText = "âˆž"; 
            });
        }

        // 3. Increment Counter
        async function incrementGlobalCounter() {
            if (!currentUser) return;
            const counterRef = doc(db, 'koan_stats', 'global');
            try {
                await updateDoc(counterRef, {
                    contemplations: increment(1)
                });
            } catch (e) {
                try {
                    await setDoc(counterRef, { contemplations: 1 }, { merge: true });
                } catch (createErr) {}
            }
        }

        // 4. Gemini Generation
        async function fetchKoan() {
            if (isGenerating) return;
            isGenerating = true;
            
            // UI: Loading State
            btn.disabled = true;
            display.classList.remove('visible'); // Fade out
            
            setTimeout(() => {
                display.innerHTML = '<span class="loading-dots text-xl text-gray-400">Emptying the cup</span>';
                display.classList.add('visible'); // Fade in loading text
            }, 1000); 

            try {
                // Increment counter in background
                incrementGlobalCounter();

                // Gemini Proxy Call - Using genartProxy with mode
                const response = await fetch("https://genartproxy-ce7zb66hpq-uc.a.run.app", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        mode: "generateText",
                        payload: {
                            messages: [
                                {
                                    role: "user",
                                    content: "You are a Zen Master. Generate a NEW, original Koan. It should be short (1-2 sentences), paradoxical, confusing, or absurd in a profound way. Focus on timeless themes: nature, the void, the self, and silence. Occasionally (1 in 5 times) you may include a subtle modern or digital metaphor, but mostly keep it elemental. Do not explain it. Do not start with 'Koan:'. Just the text.\n\nTask: Give me a koan to break my logic."
                                }
                            ]
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`Server Error: ${response.status}`);
                }

                const data = await response.json();
                
                // --- ROBUST ERROR HANDLING ---
                // Gemini API returns content in candidates array
                let rawText = data.candidates?.[0]?.content?.parts?.[0]?.text;

                // If API fails or filters content, use Fallback (The "Ancient Scroll" method)
                if (!rawText) {
                    let reason = "Unknown";
                    if (data.promptFeedback) reason = "Safety Block (Prompt)";
                    if (data.candidates?.[0]?.finishReason) reason = `Finish Reason: ${data.candidates[0].finishReason}`;
                    throw new Error(`Empty Response (${reason})`);
                }

                // Success!
                rawText = rawText.replace(/\*\*/g, "").trim();

                // Display
                setTimeout(() => {
                    display.classList.remove('visible'); // Fade out loading
                    setTimeout(() => {
                        display.innerHTML = rawText;
                        display.classList.add('visible'); // Fade in new Koan
                        btn.disabled = false;
                        btn.innerText = "Seek Another";
                        isGenerating = false;
                    }, 1000);
                }, 2000);

            } catch (error) {
                console.warn("Using Fallback due to:", error);
                
                // Even on network error, show a fallback koan to maintain immersion
                const randomIndex = Math.floor(Math.random() * fallbackKoans.length);
                const fallbackText = fallbackKoans[randomIndex];
                
                setTimeout(() => {
                    display.classList.remove('visible');
                    setTimeout(() => {
                        display.innerHTML = fallbackText;
                        display.classList.add('visible');
                        btn.disabled = false;
                        btn.innerText = "Seek Another";
                        isGenerating = false;
                    }, 1000);
                }, 2000);
            }
        }

        // Event Listeners
        btn.addEventListener('click', fetchKoan);

        // Start
        init();
        
        // Initial fade in of the placeholder
        setTimeout(() => {
            display.classList.add('visible');
        }, 100);

    </script>
</body>
</html>